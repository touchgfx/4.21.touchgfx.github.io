<!doctype html>
<html lang="zh-CN" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-basic-concepts/performance">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.1">
<link rel="search" type="application/opensearchdescription+xml" title="TouchGFX Documentation" href="/4.21/zh-CN/opensearch.xml">
<script src="/4.21/zh-CN/js/one-trust.js"></script>
<link rel="icon" href="/4.21/zh-CN/img/icons/icon-192x192.png">
<link rel="manifest" href="/4.21/zh-CN/manifest.json">
<meta name="theme-color" content="rgb(21, 142, 194)">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#000">
<link rel="apple-touch-icon" href="/4.21/zh-CN/img/icons/icon-192x192.png">
<link rel="mask-icon" href="/4.21/zh-CN/img/icon.svg" color="rgb(21, 142, 194)">
<meta name="msapplication-TileImage" content="/4.21/zh-CN/img/icons/icon-192x192.png">
<meta name="msapplication-TileColor" content="#000">
<script src="/4.21/js/fix-location.js"></script><title data-rh="true">性能 | TouchGFX Documentation</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://support.touchgfx.com/4.21/zh-CN/img/meta-image.png"><meta data-rh="true" name="twitter:image" content="https://support.touchgfx.com/4.21/zh-CN/img/meta-image.png"><meta data-rh="true" property="og:url" content="https://support.touchgfx.com/4.21/zh-CN/docs/basic-concepts/performance"><meta data-rh="true" name="docusaurus_locale" content="zh-CN"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="性能 | TouchGFX Documentation"><link data-rh="true" rel="icon" href="/4.21/zh-CN/img/favicon.png"><link data-rh="true" rel="canonical" href="https://support.touchgfx.com/4.21/zh-CN/docs/basic-concepts/performance"><link data-rh="true" rel="alternate" href="https://support.touchgfx.com/4.21/docs/basic-concepts/performance" hreflang="en"><link data-rh="true" rel="alternate" href="https://support.touchgfx.com/4.21/ko/docs/basic-concepts/performance" hreflang="ko"><link data-rh="true" rel="alternate" href="https://support.touchgfx.com/4.21/ja/docs/basic-concepts/performance" hreflang="ja"><link data-rh="true" rel="alternate" href="https://support.touchgfx.com/4.21/zh-CN/docs/basic-concepts/performance" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://support.touchgfx.com/4.21/zh-TW/docs/basic-concepts/performance" hreflang="zh-TW"><link data-rh="true" rel="alternate" href="https://support.touchgfx.com/4.21/docs/basic-concepts/performance" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://B8LNOI0XWD-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/4.21/zh-CN/assets/css/styles.56327e77.css">
<link rel="preload" href="/4.21/zh-CN/assets/js/runtime~main.35ae93fd.js" as="script">
<link rel="preload" href="/4.21/zh-CN/assets/js/main.e918fd25.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><div role="region"><a href="#" class="skipToContent_fXgn">跳转到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/4.21/zh-CN/docs/introduction/welcome"><div class="navbar__logo"><img src="/4.21/zh-CN/img/logo.svg" alt="TouchGFX" class="themedImage_ToTc themedImage--light_HNdA"><img src="/4.21/zh-CN/img/logo.svg" alt="TouchGFX" class="themedImage_ToTc themedImage--dark_i4oU"></div></a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">简体中文</a><ul class="dropdown__menu"><li><a href="/4.21/docs/basic-concepts/performance" target="_self" rel="noopener noreferrer" class="dropdown__link">English</a></li><li><a href="/4.21/ko/docs/basic-concepts/performance" target="_self" rel="noopener noreferrer" class="dropdown__link">한국어</a></li><li><a href="/4.21/ja/docs/basic-concepts/performance" target="_self" rel="noopener noreferrer" class="dropdown__link">日本語</a></li><li><a href="/4.21/zh-CN/docs/basic-concepts/performance" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">简体中文</a></li><li><a href="/4.21/zh-TW/docs/basic-concepts/performance" target="_self" rel="noopener noreferrer" class="dropdown__link">繁體中文</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/4.21/zh-CN/docs/introduction/welcome">4.21</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/4.21/zh-CN/docs/basic-concepts/performance">4.21</a></li><li><a href="https://support.touchgfx.com/4.20" target="_blank" rel="noopener noreferrer" class="dropdown__link">4.20<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://support.touchgfx.com/4.19" target="_blank" rel="noopener noreferrer" class="dropdown__link">4.19<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://support.touchgfx.com/4.18" target="_blank" rel="noopener noreferrer" class="dropdown__link">4.18<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://support.touchgfx.com/4.17" target="_blank" rel="noopener noreferrer" class="dropdown__link">4.17<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://support.touchgfx.com/4.16" target="_blank" rel="noopener noreferrer" class="dropdown__link">4.16<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://support.touchgfx.com/4.15" target="_blank" rel="noopener noreferrer" class="dropdown__link">4.15<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://support.touchgfx.com/4.14" target="_blank" rel="noopener noreferrer" class="dropdown__link">4.14<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://support.touchgfx.com/4.13" target="_blank" rel="noopener noreferrer" class="dropdown__link">4.13<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a href="https://community.st.com/s/topic/0TO0X0000003iw6WAA/touchgfx" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">社区</a><a href="https://touchgfx.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">TouchGFX.com</a><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="滚动返回顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/4.21/zh-CN/docs/category/introduction">介绍</a><button aria-label="切换可折叠边栏类别“介绍”" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/4.21/zh-CN/docs/category/basic-concepts">基本概念</a><button aria-label="切换可折叠边栏类别“基本概念”" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/4.21/zh-CN/docs/basic-concepts/embedded-graphics">嵌入式绘图系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/4.21/zh-CN/docs/basic-concepts/color-formats">色彩格式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/4.21/zh-CN/docs/basic-concepts/framebuffer">帧缓冲区</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/4.21/zh-CN/docs/basic-concepts/graphics-engine">图形引擎</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/4.21/zh-CN/docs/basic-concepts/rendering">主循环</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/4.21/zh-CN/docs/basic-concepts/performance">性能</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/4.21/zh-CN/docs/basic-concepts/operating-system">操作系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/4.21/zh-CN/docs/basic-concepts/memory-usage">内存使用</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/4.21/zh-CN/docs/development/development-introduction">开发</a><button aria-label="切换可折叠边栏类别“开发”" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/4.21/zh-CN/docs/category/miscellaneous-1">其他情况</a><button aria-label="切换可折叠边栏类别“其他情况”" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/4.21/zh-CN/docs/category/tutorials">指导</a><button aria-label="切换可折叠边栏类别“指导”" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/4.21/zh-CN/docs/api/classes/classtouchgfx_1_1_abstract_button">API</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/4.21/zh-CN/docs/category/resources">资源</a><button aria-label="切换可折叠边栏类别“资源”" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div id="doc-version-banner-identifier" class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>这是<!-- -->TouchGFX Documentation<b>4.21</b> 的文档，该版本不再被主动维护。</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/docs/basic-concepts/performance">最新版本</a></b>.</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/4.21/zh-CN/docs/category/basic-concepts"><span itemprop="name">基本概念</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">性能</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">在当前页面</button></div><div class="theme-doc-markdown markdown"><header><h1>性能</h1></header><p>本节将讨论嵌入式图形用户界面的性能。</p><p>这里的高性能是指在获得所需图形效果和动画时实现高帧率。</p><p>我们回顾一下上一节中关于主循环如何影响用户界面帧率的内容。 再次假设有一台连接到LTDC的并行RGB显示屏和两个帧缓冲。 基本情况如下：</p><div class="figure noshadow"><a href="/4.21/zh-CN/img/basic-concepts/rendering/engine-cycle-2fb-normal.webp" target="_blank"><img src="/4.21/zh-CN/img/basic-concepts/rendering/engine-cycle-2fb-normal.webp"></a><p>双帧缓冲</p></div><p>假设显示屏每秒刷新60次，则每次刷新之间的间隔约16 ms。 计算过程如下：1 s / 60 = 0.01667 s = 16.67 ms。</p><p>在1号帧缓冲的传输开始时，TouchGFX开始将1号帧绘制到2号帧缓冲。 如果1号帧的渲染在下一次传输开始前完成，则可以传输2号帧缓冲。 如果没有在16.67 ms内完成，则再次传输1号帧缓冲，并且显示屏的显示内容不变：</p><div class="figure noshadow"><a href="/4.21/zh-CN/img/basic-concepts/rendering/engine-cycle-2fb-long-render.webp" target="_blank"><img src="/4.21/zh-CN/img/basic-concepts/rendering/engine-cycle-2fb-long-render.webp"></a><p>主循环时间超过16.67 ms</p></div><p>这种情况意味着丢帧。</p><p>采集和更新阶段的时间通常是极短的，如少于1 ms，在考虑主循环消耗的总时间时，多少有些微不足道。 因此，在下文和全文中，在考虑渲染时间时，其中包括采集和更新阶段。</p><p>如果许多帧的渲染时间超过16.67 ms的时限，显示屏上的帧率将是30帧每秒（fps）。</p><p>如果渲染时间大体上短于16.67 ms，但有一些帧超过16.67 ms，则平均帧率可能接近60 fps，但在用户看来动画可能不流畅。 动画中的某些步骤可能看起来过快而某些又过慢，具体取决于应用。 这不符合我们的期望。</p><p>渲染时间还可能更长。 如果刚好超过33 ms，由于每三次传输只有一个新帧就绪，帧率将降至20 fps。</p><table><thead><tr><th>FPS(帧率)</th><th>最长渲染时间</th></tr></thead><tbody><tr><td>60</td><td>16.67 ms</td></tr><tr><td>30</td><td>33.34 ms</td></tr><tr><td>20</td><td>50.00 ms</td></tr><tr><td>15</td><td>66.67 ms</td></tr></tbody></table><p>此表显示了给定帧率可获得的最长渲染时间（包括采集和更新阶段）。</p><p>为了获得良好的用户界面性能，最好定期检查和监测帧率。 可使用两种方法：</p><ul><li>测量渲染时间</li><li>丢帧计数</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="measuring-the-rendering-time">测量渲染时间<a class="hash-link" href="#measuring-the-rendering-time" title="直接链接到标题">​</a></h2><p>测量渲染时间的第一种方法提供了最详细的信息。 其理念实际上是测量从帧传输到渲染阶段结束之间的时间。 图形引擎在采集阶段开始时调用GPIO类的函数，并在渲染阶段结束时再次调用。 应用定义这些函数，并能钩子函数以便执行测量。</p><p>测量可通过两种方式来执行：</p><ul><li>使用外部计时设备，如示波器：为了使用示波器进行测量，应用应从<code>GPIO</code>接口实现<code>set(GPIO_ID)</code>和<code>clear(GPIO_ID)</code>方法。 然后，示波器可以测量输出为高电平的持续时间，以此作为渲染时间。</li><li>使用内部计时器：另一种方法是使用内部计时器，如sysTick计时器。 在调用GPIO::set(RENDER_TIME)，应用可将计时器的值保存在变量中。 在进行清零调用时，应用可再次读取计时器并减去前值，从而获得渲染时间。 计时器的速度将决定测量精度。 应用必须以某种方式使渲染时间可见。 一种方式是将值保存在全局变量中，并且可以在界面上的TextArea中显示值。 也可使用调试器检查值。</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="counting-the-lost-frames">丢帧计数<a class="hash-link" href="#counting-the-lost-frames" title="直接链接到标题">​</a></h2><p>图形引擎对上一个采集-更新-渲染阶段中发生的传输次数进行计数。 应用可轻松地检查此值，以便了解是否丢帧以及帧率是否下降。</p><p>计数在<em>HAL</em>类中提供：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">handleTickEvent</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  tickCounter </span><span class="token operator" style="color:rgb(137, 221, 255)">+=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token class-name" style="color:rgb(255, 203, 107)">HAL</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token function" style="color:rgb(130, 170, 255)">getInstance</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token operator" style="color:rgb(137, 221, 255)">-&gt;</span><span class="token function" style="color:rgb(130, 170, 255)">getLCDRefreshCount</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">//Alert programmer somehow</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="compensating-for-lost-frames">丢帧补偿<a class="hash-link" href="#compensating-for-lost-frames" title="直接链接到标题">​</a></h3><p>如果丢帧且某个动画的帧率因此下降，可进行一定程度的补偿。 我们可以：</p><ul><li>等待其结束 - 让动画继续，这会导致动画持续时间变长，并且动画可能不流畅。</li><li>跳过一些帧 - 通过跳帧确保整个动画的持续时间不会超过预定时间。</li></ul><p>如果丢帧，可指示TouchGFX自动跳过一些帧。 可通过在每个实际帧将动画tick一次以上来实现。 当渲染时间不稳定时，这有助于让动画更流畅。</p><div class="code-header"><div><h5>HAL.hpp</h5></div></div><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">setFrameRateCompensation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">bool</span><span class="token plain"> enabled</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="what-affects-the-rendering-time">影响渲染时间的因素有哪些？<a class="hash-link" href="#what-affects-the-rendering-time" title="直接链接到标题">​</a></h2><p>影响渲染时间的因素有许多：更新部分的大小、分层的使用、控件的复杂度和渲染可使用的硬件支持。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-much-of-the-screen-is-updated">界面更新了多少？<a class="hash-link" href="#how-much-of-the-screen-is-updated" title="直接链接到标题">​</a></h3><p>渲染时间通常与必须更新的像素数成正比。 如果动画需要的渲染时间过长，一种可能的解决办法是缩小动画面积。 例如，如果有一张旋转图像而性能不够好，则可通过缩小图像尺寸来改善性能。</p><div class="figure noshadow"><a href="/4.21/zh-CN/img/basic-concepts/performance/reducing-image-size.webp" target="_blank"><img src="/4.21/zh-CN/img/basic-concepts/performance/reducing-image-size.webp"></a><p>通过缩小图像尺寸缩短渲染时间</p></div><p>记住，图形引擎会重绘应用使之无效的区域。 这意味着必须只使实际需要刷新的区域无效。</p><p><em>无效区域越大，渲染时间越长。</em></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-number-of-layers-in-the-graphics">图形中的层数<a class="hash-link" href="#the-number-of-layers-in-the-graphics" title="直接链接到标题">​</a></h3><p>在典型应用中，图形将包含彼此堆叠的不同元素。 如果更新了元素中的一个，通常必须重绘所有元素。</p><p>典型的例子是背景图像、帧和一些文本：</p><div class="figure noshadow"><a href="/4.21/zh-CN/img/basic-concepts/performance/text-in-a-frame.webp" target="_blank"><img src="/4.21/zh-CN/img/basic-concepts/performance/text-in-a-frame.webp"></a><p>分层图形元素</p></div><p>此用户界面的创建方法是将TextArea控件放在显示了一个透明帧的Image控件上方。 二者都在背景图像上层：</p><div class="figure noshadow"><a href="/4.21/zh-CN/img/basic-concepts/performance/text-in-a-frame-designer-4.17.webp" target="_blank"><img src="/4.21/zh-CN/img/basic-concepts/performance/text-in-a-frame-designer-4.17.webp"></a><p>TouchGFX Designer中的分层图形元素</p></div><p>此解决方案在应用中经常用到。 这是一种十分简单的解决方案，具有高度的灵活性，例如，可以在运行时间更改帧或在背景上移动帧和文本。</p><p>关于渲染时间的问题是如果在运行时间更新了文本且需要重绘，图形引擎还需要重绘背景和帧，然后是新的文本。 这会显著增加文本的渲染时间。</p><p><em>无效区域的层数越多，渲染时间就越长。</em></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-complexity-of-rendering-the-pixels">渲染像素的复杂度<a class="hash-link" href="#the-complexity-of-rendering-the-pixels" title="直接链接到标题">​</a></h3><p>将每个像素渲染到帧缓冲的难度并不一致。 在所有类型的渲染中，图形引擎必须将最终的像素写入帧缓冲。 但是，要写入像素的计算需要的消耗并不相同。</p><p>固定色彩（如Box Widget中使用的色彩）的消耗最低，只需计算一个像素并将结果重复用于所有像素。 这意味着使用许多Box可获得非常高的性能。 由于这会导致用户界面质量不高，因此不建议这样做。</p><p>第二低的是图像的像素计算消耗，这是因为像素均以可直接使用的格式存储在位图中。 计算要写入帧缓冲的像素关系到从位图中的正确位置加载色彩值。</p><p>文本的消耗与图像相当，每个字母实际上都是一幅小图像。 事实上，由于大量小图像导致了相当高的“开始-停止”消耗，因此文本的消耗更高。 例如，每个字母的位置计算。 为了让文本看起来尽可能美观，会将文本显示为具有透明度的小图像，请参见下文关于透明的注释。</p><p>旋转或缩放后的图像消耗更高。 任务同样是从位图加载像素值，但由于图形引擎必须包含缩放和旋转，因此这时的计算更耗时。</p><p>几何元素（如圆）的消耗比之更高。 这时我们不能从位图加载像素色彩，而是必须计算圆的形状和圆中每个像素的色彩。</p><p>透明度增加了元素的绘制消耗。 如果一些像素不是实心的，那么元素是透明的。 图形引擎首先必须绘制透明元素后方的元素（如“帧中的文本”部分所述），这会增加绘制的消耗。 其次，图形引擎随后必须将背景像素与透明元素的像素进行组合，并将结果写入帧缓冲。 此类计算的耗时显著多于只写入计算过的像素的场景。</p><div class="figure noshadow"><a href="/4.21/zh-CN/img/basic-concepts/performance/box-image-texture-circle.webp" target="_blank"><img src="/4.21/zh-CN/img/basic-concepts/performance/box-image-texture-circle.webp"></a><p>Box、Image、旋转Image和圆。 实心元素位于第一行。 透明元素在下方。</p></div><p>透明总是需要多出一层。 但是，将实心像素放在其他实心像素的上方并不一定会增加层数。 图形引擎尽量不绘制被其他实心像素覆盖的像素，因为这是在浪费宝贵的时间。</p><p><em>无效区域中元素的复杂度越高，渲染时间就越长。</em></p><p>记住，只有无效区域中的元素才会增加渲染时间。 无效区域之外的元素对渲染时间无影响。</p><p>点击<a href="/4.21/zh-CN/docs/development/ui-development/ui-components/general-ui-component-performance">此处</a>阅读关于UI组件和性能的更多内容。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="hardware-support-for-rendering">渲染的硬件支持<a class="hash-link" href="#hardware-support-for-rendering" title="直接链接到标题">​</a></h3><p>一些STM32微控制器包含图形加速器Chrom-ART（或DMA2D）。 此加速器可缩短渲染时间。 由于加速器与微控制器核心并行运行，微控制器可以在加速器渲染图形时自由地运行其他任务。</p><p>Chrom-ART主要用于图像和文本。 如果有，图形引擎会自动使用它。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="when-should-you-consider-rendering-time">何时应考虑渲染时间<a class="hash-link" href="#when-should-you-consider-rendering-time" title="直接链接到标题">​</a></h2><p>渲染时间并非总是那么重要。 当低帧率可被用户观察到时，应注意渲染时间。 当动画在屏幕的一部分上运行（如旋转的图标）或您在界面上移动或滑动某元素时，通常就属于这种情况。 如果更新频率低，那么在用户看来，动画将呈现出分步显示而非流畅的状态。 如果是这样，应检查渲染时间。</p><p>另一方面，如果用新界面替代整个界面，当更换期间帧率显著下降时，用户通常注意不到。 这是因为用户看不到渲染何时开始，只能看到它何时结束。</p><p>这两条规则意味着对于动画元素（如移动元素）而言，应使用较少的层数，避免使用复杂元素和许多层数。 对于界面的其余部分，这些不是问题。</p><div class="figure noshadow"><a href="/4.21/zh-CN/img/basic-concepts/performance/clock-and-scrolllist.webp" target="_blank"><img src="/4.21/zh-CN/img/basic-concepts/performance/clock-and-scrolllist.webp"></a><p>模拟时钟和滚动列表</p></div><p>在本例中，左侧有一个模拟时钟。 通过旋转三幅细长的图像渲染三根指针。 这通常不难实现，因为指针并非总是在移动。 但如果我们要让时钟在界面上到处移动，将会在每一帧中重绘指针，由于绘制旋转图像通常比较耗时，因此会比较复杂。</p><p>右侧是一个滚动列表。 用户可以上下移动此数字列表，为了让用户界面显示出高响应性，需要高帧率。 因此，必须考虑滚动列表中元素的渲染时间，或者缩小滚动列表的尺寸。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="optimize-performance-by-invalidating-content">通过使内容无效来优化性能<a class="hash-link" href="#optimize-performance-by-invalidating-content" title="直接链接到标题">​</a></h2><p>通常整个控件均无效，但图形引擎只能使控件的内容无效，而不能使整个控件无效。 通过减少无效区域，渲染时间一般会明显缩短。 渲染时间的改进取决于：</p><ul><li>控件内容覆盖的区域相对于整个控件的大小。</li><li>背景控件部分或全部被控件覆盖。</li></ul><p>下图以TextArea控件为例说明了内容无效的概念。 图1显示了控件的整个区域。 图2显示了使用<code>TextArea::invalidate()</code>时的无效区域。 图3显示了使用<code>TextArea::invalidate()</code>时的无效区域。</p><div class="figure noshadow"><a href="/4.21/zh-CN/img/basic-concepts/performance/text-area-expanded-across-screen.webp" target="_blank"><img src="/4.21/zh-CN/img/basic-concepts/performance/text-area-expanded-across-screen.webp"></a><p>图1. 横跨整个屏幕宽度的文本区域</p></div><div class="figure noshadow"><a href="/4.21/zh-CN/img/basic-concepts/performance/invalidate-example.webp" target="_blank"><img src="/4.21/zh-CN/img/basic-concepts/performance/invalidate-example.webp"></a><p>图2. 使用TextArea::invalidate()时无效的区域(红色)</p></div><div class="figure noshadow"><a href="/4.21/zh-CN/img/basic-concepts/performance/invalidate-content-example.webp" target="_blank"><img src="/4.21/zh-CN/img/basic-concepts/performance/invalidate-content-example.webp"></a><p>图3. 使用TextArea::invalidateContent()时无效的区域(绿色)</p></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用textareainvalidatecontent的示例">使用TextArea::invalidateContent()的示例<a class="hash-link" href="#使用textareainvalidatecontent的示例" title="直接链接到标题">​</a></h3><p>在控件与其他控件重叠的情况下，使用<code>TextArea::invalidate()</code>使整个TextArea无效时，需要重新绘制其他控件。 通过改用<code>TextArea::invalidateContent()</code>，我们将不必要的无效和重绘控件的风险降至最低。 这对于昂贵的控件尤其如此，例如：圆、仪表等。</p><p>下图说明了如何避免使用<code>TextArea::invalidateContent()</code>使背景控件（图像-意法半导体标志）无效。 如果我们使用<code>TextArea::invalidate()</code>，将会使后台控件无效并重新绘制。</p><div class="figure noshadow"><a href="/4.21/zh-CN/img/basic-concepts/performance/invalidate-content-improvement-example.webp" target="_blank"><img src="/4.21/zh-CN/img/basic-concepts/performance/invalidate-content-improvement-example.webp"></a><p>使用TextArea::invalidateContent()的示例</p></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="tips-to-get-good-performance">获得良好性能的建议<a class="hash-link" href="#tips-to-get-good-performance" title="直接链接到标题">​</a></h2><p>我们总结了获得良好性能的建议，以结束本节内容：</p><ul><li><strong>不要重绘未更改的部分</strong> 确保没有误操作将界面上不必要的部分失效。 这会降低性能且无任何益处。</li><li><strong>在质量与速度之间寻求平衡</strong> 降低元素的复杂度有助于提高性能。 复杂度与性能之间的良好平衡通常极为关键。</li><li><strong>利用硬件能力</strong> 具有硬件加速（Chrom-ART）的微控制器的能力通常高于没有硬件加速的微控制器。 考虑使用具有Chrom-ART的微控制器。</li><li><strong>用图像替代计算图形</strong> 计算得到的圆比圆图像慢。 一般而言，图像可替代许多静态元素。</li><li><strong>调整显示屏刷新率</strong> 如本节开头所述，刷新率是渲染时间的硬性限制。 如果渲染时间超过刷新率，帧率将下降。 如果渲染时间只超过刷新率一点点，也许能够将显示屏的刷新率降至如55 Hz（相当于18.2 ms）这样的水平，并维持高帧率。</li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档页面导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/4.21/zh-CN/docs/basic-concepts/rendering"><div class="pagination-nav__sublabel">上一个</div><div class="pagination-nav__label">主循环</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/4.21/zh-CN/docs/basic-concepts/operating-system"><div class="pagination-nav__sublabel">下一个</div><div class="pagination-nav__label">操作系统</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#measuring-the-rendering-time" class="table-of-contents__link toc-highlight">测量渲染时间</a></li><li><a href="#counting-the-lost-frames" class="table-of-contents__link toc-highlight">丢帧计数</a><ul><li><a href="#compensating-for-lost-frames" class="table-of-contents__link toc-highlight">丢帧补偿</a></li></ul></li><li><a href="#what-affects-the-rendering-time" class="table-of-contents__link toc-highlight">影响渲染时间的因素有哪些？</a><ul><li><a href="#how-much-of-the-screen-is-updated" class="table-of-contents__link toc-highlight">界面更新了多少？</a></li><li><a href="#the-number-of-layers-in-the-graphics" class="table-of-contents__link toc-highlight">图形中的层数</a></li><li><a href="#the-complexity-of-rendering-the-pixels" class="table-of-contents__link toc-highlight">渲染像素的复杂度</a></li><li><a href="#hardware-support-for-rendering" class="table-of-contents__link toc-highlight">渲染的硬件支持</a></li></ul></li><li><a href="#when-should-you-consider-rendering-time" class="table-of-contents__link toc-highlight">何时应考虑渲染时间</a></li><li><a href="#optimize-performance-by-invalidating-content" class="table-of-contents__link toc-highlight">通过使内容无效来优化性能</a><ul><li><a href="#使用textareainvalidatecontent的示例" class="table-of-contents__link toc-highlight">使用TextArea::invalidateContent()的示例</a></li></ul></li><li><a href="#tips-to-get-good-performance" class="table-of-contents__link toc-highlight">获得良好性能的建议</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">All rights reserved © 2023 STMicroelectronics | <a href="https://www.st.com/content/st_com/en/common/terms-of-use.html">Terms of use</a> | <a href="https://www.st.com/content/st_com/en/common/privacy-policy.html">Privacy Policy</a> | <a href="/docs/miscellaneous/cookie-policy">Cookie Policy</a> | <a href="https://app-de.onetrust.com/app/#/webform/2b87200d-4023-4588-9df7-ab0cdea1a67e">Exercise your rights</a></div></div></div></footer></div></div>
<script src="/4.21/zh-CN/assets/js/runtime~main.35ae93fd.js"></script>
<script src="/4.21/zh-CN/assets/js/main.e918fd25.js"></script>
</body>
</html>