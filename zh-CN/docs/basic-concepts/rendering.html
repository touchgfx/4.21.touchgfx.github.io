<!doctype html>
<html lang="zh-CN" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-basic-concepts/rendering">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.1">
<link rel="search" type="application/opensearchdescription+xml" title="TouchGFX Documentation" href="/4.21/zh-CN/opensearch.xml">
<script src="/4.21/zh-CN/js/one-trust.js"></script>
<script src="/4.21/js/fix-location.js"></script><title data-rh="true">主循环 | TouchGFX Documentation</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://support.touchgfx.com/4.21/zh-CN/img/meta-image.png"><meta data-rh="true" name="twitter:image" content="https://support.touchgfx.com/4.21/zh-CN/img/meta-image.png"><meta data-rh="true" property="og:url" content="https://support.touchgfx.com/4.21/zh-CN/docs/basic-concepts/rendering"><meta data-rh="true" name="docusaurus_locale" content="zh-CN"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="主循环 | TouchGFX Documentation"><link data-rh="true" rel="icon" href="/4.21/zh-CN/img/favicon.png"><link data-rh="true" rel="canonical" href="https://support.touchgfx.com/4.21/zh-CN/docs/basic-concepts/rendering"><link data-rh="true" rel="alternate" href="https://support.touchgfx.com/4.21/docs/basic-concepts/rendering" hreflang="en"><link data-rh="true" rel="alternate" href="https://support.touchgfx.com/4.21/ko/docs/basic-concepts/rendering" hreflang="ko"><link data-rh="true" rel="alternate" href="https://support.touchgfx.com/4.21/ja/docs/basic-concepts/rendering" hreflang="ja"><link data-rh="true" rel="alternate" href="https://support.touchgfx.com/4.21/zh-CN/docs/basic-concepts/rendering" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://support.touchgfx.com/4.21/zh-TW/docs/basic-concepts/rendering" hreflang="zh-TW"><link data-rh="true" rel="alternate" href="https://support.touchgfx.com/4.21/docs/basic-concepts/rendering" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://B8LNOI0XWD-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/4.21/zh-CN/assets/css/styles.a3789d89.css">
<link rel="preload" href="/4.21/zh-CN/assets/js/runtime~main.1202490c.js" as="script">
<link rel="preload" href="/4.21/zh-CN/assets/js/main.8eee2a9c.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><div role="region"><a href="#" class="skipToContent_fXgn">跳转到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" target="_self" href="/4.21/zh-CN/docs/introduction/welcome"><div class="navbar__logo"><img src="/4.21/zh-CN/img/logo.svg" alt="TouchGFX" class="themedImage_ToTc themedImage--light_HNdA"><img src="/4.21/zh-CN/img/logo.svg" alt="TouchGFX" class="themedImage_ToTc themedImage--dark_i4oU"></div></a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">简体中文</a><ul class="dropdown__menu"><li><a href="/4.21/docs/basic-concepts/rendering" target="_self" rel="noopener noreferrer" class="dropdown__link">English</a></li><li><a href="/4.21/ko/docs/basic-concepts/rendering" target="_self" rel="noopener noreferrer" class="dropdown__link">한국어</a></li><li><a href="/4.21/ja/docs/basic-concepts/rendering" target="_self" rel="noopener noreferrer" class="dropdown__link">日本語</a></li><li><a href="/4.21/zh-CN/docs/basic-concepts/rendering" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active">简体中文</a></li><li><a href="/4.21/zh-TW/docs/basic-concepts/rendering" target="_self" rel="noopener noreferrer" class="dropdown__link">繁體中文</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/4.21/zh-CN/docs/introduction/welcome">4.21</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/4.21/zh-CN/docs/basic-concepts/rendering">4.21</a></li><li><a href="https://support.touchgfx.com/4.20" target="_blank" rel="noopener noreferrer" class="dropdown__link">4.20<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://support.touchgfx.com/4.19" target="_blank" rel="noopener noreferrer" class="dropdown__link">4.19<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://support.touchgfx.com/4.18" target="_blank" rel="noopener noreferrer" class="dropdown__link">4.18<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://support.touchgfx.com/4.17" target="_blank" rel="noopener noreferrer" class="dropdown__link">4.17<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://support.touchgfx.com/4.16" target="_blank" rel="noopener noreferrer" class="dropdown__link">4.16<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://support.touchgfx.com/4.15" target="_blank" rel="noopener noreferrer" class="dropdown__link">4.15<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://support.touchgfx.com/4.14" target="_blank" rel="noopener noreferrer" class="dropdown__link">4.14<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li><a href="https://support.touchgfx.com/4.13" target="_blank" rel="noopener noreferrer" class="dropdown__link">4.13<svg width="12" height="12" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><a href="https://community.st.com/s/topic/0TO0X0000003iw6WAA/touchgfx" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">社区</a><a href="https://touchgfx.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">TouchGFX.com</a><div class="searchBox_ZlJk"><div class="searchBox_Gz_y"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/4.21/zh-CN/docs/category/introduction">介绍</a><button aria-label="Toggle the collapsible sidebar category &#x27;介绍&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/4.21/zh-CN/docs/category/basic-concepts">基本概念</a><button aria-label="Toggle the collapsible sidebar category &#x27;基本概念&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/4.21/zh-CN/docs/basic-concepts/embedded-graphics">嵌入式绘图系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/4.21/zh-CN/docs/basic-concepts/color-formats">色彩格式</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/4.21/zh-CN/docs/basic-concepts/framebuffer">帧缓冲区</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/4.21/zh-CN/docs/basic-concepts/graphics-engine">图形引擎</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/4.21/zh-CN/docs/basic-concepts/rendering">主循环</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/4.21/zh-CN/docs/basic-concepts/performance">性能</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/4.21/zh-CN/docs/basic-concepts/operating-system">操作系统</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/4.21/zh-CN/docs/basic-concepts/memory-usage">内存使用</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/4.21/zh-CN/docs/development/development-introduction">开发</a><button aria-label="Toggle the collapsible sidebar category &#x27;开发&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/4.21/zh-CN/docs/category/miscellaneous-1">其他情况</a><button aria-label="Toggle the collapsible sidebar category &#x27;其他情况&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/4.21/zh-CN/docs/category/tutorials">指导</a><button aria-label="Toggle the collapsible sidebar category &#x27;指导&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/4.21/zh-CN/docs/api/classes/classtouchgfx_1_1_abstract_button">API</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/4.21/zh-CN/docs/category/resources">资源</a><button aria-label="Toggle the collapsible sidebar category &#x27;资源&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/4.21/zh-CN/docs/category/basic-concepts"><span itemprop="name">基本概念</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">主循环</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">在当前页面</button></div><div class="theme-doc-markdown markdown"><header><h1>主循环</h1></header><p>在本节中，您将学习更多关于TouchGFX中图形引擎的工作方式特别是主循环的内容。 回想一下，图形引擎的主要任务是将应用的图形（ui模型）渲染到帧缓冲。 此过程反复发生，以便在显示屏上产生新的帧。</p><div class="figure noshadow"><a href="/4.21/zh-CN/img/basic-concepts/rendering/engine-cycle.webp" target="_blank"><img width="320" src="/4.21/zh-CN/img/basic-concepts/rendering/engine-cycle.webp"></a><p></p></div><p>图形引擎<em>采集</em>部事件，例如显示屏触摸或按钮按下事件。 这些事件经过筛选后被转发到应用。 应用可使用这些事件更新UI模型。 如 在用户触摸屏幕上的按钮时将按钮更改为按下状态，然后在用户不再触摸屏幕时将按钮改回释放状态。</p><p>最后，图形引擎将更新后的模型渲染到帧缓冲。 此过程无限循环。</p><p>在渲染帧后，帧缓冲被传输到显示屏，用户可从显示屏上看到图形。 为避免显示屏上的抖动毛刺干扰，传输过程必须与显示屏同步。 For some displays the transfers must happen regularly with a minimum time interval. 对于其余显示屏，必须在显示屏发出信号时进行传输。</p><p>The graphics engine implements this synchronization by waiting for a &quot;go&quot; signal from the hardware abstraction layer. 点击<a href="/4.21/zh-CN/docs/development/touchgfx-hal-development/touchgfx-al-development-introduction">此处</a>阅读关于硬件抽象层的更多内容</p><p>在伪代码中，TouchGFX图形引擎内部的主循环大致是这样的：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">while</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token boolean" style="color:rgb(255, 88, 116)">true</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">collect</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Collect events from outside</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">update</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">     </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Update the application ui model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">render</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">     </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Render new updated graphics to the framebuffer</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">wait</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">       </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Wait for &#x27;go&#x27; from display</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>代码更多地涉及实际实现，但上述伪代码有助于理解引擎的主要部分。</p><p>下面我们将详细讨论这四个阶段。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="collect">采集<a class="hash-link" href="#collect" title="直接链接到标题">​</a></h2><p>在该阶段，图形引擎从外部环境采集事件。 这些事件通常是触摸事件和按钮。</p><p>TouchGFX对事件进行采集并传递到应用。 原始触摸事件会被转换为更具体的触摸事件：</p><ul><li><strong>点击：</strong>用户用手指在屏幕上按下或松开</li><li><strong>拖曳：</strong>用户在屏幕上移动其手指（在触摸屏幕的同时）。</li><li><strong>手势：</strong>用户沿某个方向快速移动其手指然后释放。 这被称为<em>滑动</em>，由图形引擎识别。</li></ul><p>事件被转发到当前活动的UI元素（如控件）。</p><p>引擎还转发<em>tick</em>事件。 此事件表示新的帧（或时间节拍），会一直发送，在没有其他外部输入时也会发送。 This event is used by applications to drive animations, or other time-based actions like changing to a pause screen after a specific time has elapsed.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="update">更新<a class="hash-link" href="#update" title="直接链接到标题">​</a></h2><p>图形引擎与应用一起更新UI，以便反映采集的事件。 图形引擎知晓当前活动的界面，并将事件传递给该对象。</p><p>基本原理是引擎将事件通知应用（即UI模型中的Screen和Widget对象）。 作为响应，应用请求重绘界面的特定部分。 The application does not draw directly as response to the events, it changes the properties of Widgets and requests a redraw of the Widget.</p><p>If for example a Click event occurs, the graphics engine searches the scene model of the Screen object to find the Widget that should receive the event (the topmost widget below the touch point). Some Widgets like Image and TextArea do not wish to receive Click events, so they are disregarded. They also have an empty event handler.</p><p>其他Widget（如Button）会响应Click事件（按下或释放）。 The Button widget, for example, changes its state to show another image when pressed, and changes the state back again when the touch is released again.</p><div class="figure noshadow"><a href="/4.21/zh-CN/img/basic-concepts/rendering/button-on-image.webp" target="_blank"><img width="480" src="/4.21/zh-CN/img/basic-concepts/rendering/button-on-image.webp"></a><p>Image控件在背景层，Button控件在顶层</p></div><p>当Widget（如Button）改变其状态时，也必须在帧缓冲中重绘它。 作为对事件的响应，Widget负责将此信息传回图形引擎。 The graphics engine does not on its own redraw any Widgets based on the collected events. The Widgets keep track of their own internal state (for a Button, what image to draw), and instruct the graphics engine to redraw the part (a rectangle) of the display that is covered by the Widget.</p><p>应用本身也能对事件做出响应。 通常使用以下两种方式中的一种：</p><ul><li><strong>在TouchGFX Designer中为Widget配置<a href="/4.21/zh-CN/docs/development/ui-development/designer-user-guide/interactions-view">交互</a></strong> 例如，我们可以配置交互，让另一个Widget在Button被按下时可见。 此交互在Button更改其状态并从图形引擎请求重绘自身之后执行。 如果使用此交互显示另一个（不可见）Widget，应用还应从图形引擎请求重绘。</li><li><strong>在界面上响应事件</strong> 也可以直接在界面上响应事件。 The event handlers are virtual functions on the Screen class (see list below). 这些函数可在应用的Screen中重复实现。 This can e.g. be used to perform an action whenever the user touches the screen (no matter where if the touch is on a Widget).</li></ul><p>Screen类具有下列事件处理器。 在采集到相应外部事件后，图形引擎会调用这些函数：</p><div class="code-header"><div><h5>framework/include/touchgfx/Screen.hpp</h5></div></div><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">virtual</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">handleClickEvent</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> ClickEvent</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">virtual</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">handleDragEvent</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> DragEvent</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">virtual</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">handleGestureEvent</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">const</span><span class="token plain"> GestureEvent</span><span class="token operator" style="color:rgb(137, 221, 255)">&amp;</span><span class="token plain"> event</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">virtual</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">handleTickEvent</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">virtual</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">handleKeyEvent</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">uint8_t</span><span class="token plain"> key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以在这些事件处理器中插入任何C++代码。 应用通常会更新一些Widget的状态和/或调用一些应用特定的函数（业务逻辑）。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="time-based-updates">基于时间的更新<a class="hash-link" href="#time-based-updates" title="直接链接到标题">​</a></h3><p>handleTickEvent事件处理器在每一帧都会被调用。 这使得应用能够基于时间更新用户界面。 例如，在10秒后Widget渐隐。 Assuming that we have 60 frames in a second (10 seconds is then 600 ticks), the code could look like:</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">handleTickEvent</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token class-name" style="color:rgb(255, 203, 107)">Screen1ViewBase</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token function" style="color:rgb(130, 170, 255)">handleTickEvent</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">     </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Call superclass eventhandler</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    tickCounter </span><span class="token operator" style="color:rgb(137, 221, 255)">+=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">tickCounter </span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">600</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        myWidget</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">startFadeAnimation</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">20</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Fade to 0 = invisible in 20 frames</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>图形引擎还将调用Model类上的事件处理器。 此事件处理器通常用于执行重复操作，如检查消息队列或进行GPIO采样：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(255, 203, 107)">Model</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token function" style="color:rgb(130, 170, 255)">tick</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">bool</span><span class="token plain"> b </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">sampleGPIO_Input1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Sample polled IO</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">b</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The eventhandler on a specific Screen subclass is only called when that screen is the active screen. The eventhandler on the Model class is always called (independently of which Screen is active). This makes the Model eventhandler suitable for &quot;application wide&quot; logic.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="requesting-a-redraw">请求重绘<a class="hash-link" href="#requesting-a-redraw" title="直接链接到标题">​</a></h3><p>正如上文所述，以Button为例，Widget负责在其状态改变时请求重绘。 这背后的机制称为<em>无效区域</em>。</p><p>当Button改变状态（如从释放变为按下）并需要重绘时，Button Widget覆盖的区域即为无效区域。 图形引擎保留了为帧请求的这些无效区域的列表。 采集的所有事件（触摸、按钮和tick）可能导致一个或多个无效区域，因此每一帧可能有许多个无效区域。</p><p>Screen类上的事件处理器也可以请求区域重绘。 下面我们更改第10帧的Box控件box1的色彩，并通过调用Box上的<em>Invalidate</em>方法请求重绘：</p><div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">handleTickEvent</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token class-name" style="color:rgb(255, 203, 107)">Screen1ViewBase</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token function" style="color:rgb(130, 170, 255)">handleTickEvent</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">                          </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Call superclass eventhandler</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    tickCounter </span><span class="token operator" style="color:rgb(137, 221, 255)">+=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">tickCounter </span><span class="token operator" style="color:rgb(137, 221, 255)">==</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">10</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        box1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">setColor</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token class-name" style="color:rgb(255, 203, 107)">Color</span><span class="token double-colon punctuation" style="color:rgb(199, 146, 234)">::</span><span class="token function" style="color:rgb(130, 170, 255)">getColorFromRGB</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">0xFF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0x00</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0x00</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Set color to red</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        box1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token function" style="color:rgb(130, 170, 255)">invalidate</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">                                       </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// Request redraw</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>在本例中，图形引擎将在每一帧中调用<em>handleTickEvent</em>handler。 在第10帧，应用代码请求重绘<em>box1</em>覆盖的区域。 作为对该请求的响应，图形引擎将在帧缓冲中用<em>box1</em>控件中保存的色彩重绘该区域。</p><p>在下面的用户界面中，背景图像上方有一个Button Widget和一个Box Widget。 如果我们在Button上插入一个交互，以便在Button被点击时更改Box的色彩，那么当用户点击Button时，我们会得到两个无效区域（用红色表示）：</p><div class="figure noshadow"><a href="/4.21/zh-CN/img/basic-concepts/rendering/button-and-box.webp" target="_blank"><img width="480" src="/4.21/zh-CN/img/basic-concepts/rendering/button-and-box.webp"></a><p>两个无效区域</p></div><p>为了获得帧缓冲中绘制的新色彩，需要先将Box的区域无效化。 为了重新绘制释放状态，Button还将自身无效化。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="render">渲染<a class="hash-link" href="#render" title="直接链接到标题">​</a></h2><p>如前文所述，更新阶段的结果是待重绘区域（无效区域）的列表。 渲染阶段的任务实际上是遍历此列表，并将覆盖这些区域的Widget绘制到帧缓冲。</p><p>此阶段由图形引擎自动处理。 应用已经定义了场景模型（ui中的Widget）并使一些区域无效化。 其余的工作由引擎来处理。</p><p>图形引擎逐一处理无效区域。 引擎扫描每个区域的场景模型，并采集区域覆盖（部分或全部）的Widget的列表。</p><p>根据此Widget列表，图形引擎调用Widget上的绘制方法。 从背景层中的Widget开始，到最前面的Widget结束。</p><p>在绘制到帧缓冲时，Widget的绘制方法会用到Widget的状态（如色彩）。 在更新阶段，绘制Widget所需的任何信息都必须保存到Widget。 否则，在渲染阶段将无法获取此信息。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="wait">Wait<a class="hash-link" href="#wait" title="直接链接到标题">​</a></h2><p>TouchGFX图形引擎在更新和渲染下一帧之前等待一个信号。 之所以在帧之间等待而不是尽快地继续渲染帧，原因有两个：</p><ul><li><p>渲染与显示屏同步。 如上文所述，一些显示屏需要反复发送帧缓冲。 While this transmission is ongoing, it is not advisable to render arbitrarily to the framebuffer. 因此，图形引擎会在发送开始后等待一小段时间，然后再开始渲染。 在应发送帧缓冲时，其他显示屏向微控制器发送信号。 图形引擎等待该信号。</p></li><li><p>按固定速率渲染帧。 对于应用而言，按固定速率渲染帧的好处是更容易创建持续特定时间的动画。 例如，如果显示屏频率为60 Hz，则应将两秒钟的动画设定为在120帧内完成。</p></li></ul><p>图形引擎的等待时间通常被应用中其他优先级较低的进程利用。 在这种情况下，时间不会被浪费，优先级较低的进程反正都应在某些时间点运行。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="handling-the-framebuffers">处理帧缓冲<a class="hash-link" href="#handling-the-framebuffers" title="直接链接到标题">​</a></h2><p>如前文所述，图形引擎会在更新帧缓冲之前与显示屏同步。 在渲染到帧缓冲后，引擎还需确保显示屏显示更新后的帧缓冲。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="two-framebuffers">两个帧缓冲<a class="hash-link" href="#two-framebuffers" title="直接链接到标题">​</a></h3><p>在最简单的设置中，有两个帧缓冲可供使用。 图形引擎在两个帧缓冲之间切换。 在将帧绘制到一个帧缓冲的同时，将另一个帧缓冲传输到（并显示在）显示屏上。</p><div class="figure noshadow"><a href="/4.21/zh-CN/img/basic-concepts/rendering/engine-cycle-2fb-normal.webp" target="_blank"><img src="/4.21/zh-CN/img/basic-concepts/rendering/engine-cycle-2fb-normal.webp"></a><p>双帧缓冲</p></div><p>在此次绘制中，假设并行RGB显示屏连接了LTDC控制器。 这意味着在每一帧中都必须将帧缓冲发送到显示屏。 由于有两个帧缓冲，图形引擎可以在发送一个帧缓冲的同时将帧绘制到另一个帧缓冲。 此方案效果很好，如可能，应作为首选方案。</p><p>由于图形引擎在每一帧都进行绘制，在上面的绘制中，我们也在所有帧发送新的帧缓冲。</p><p>常常会有应用不更新帧任何内容的情况。 这表示不进行任何渲染。 因此，在下一帧会再次发送相同的帧缓冲。</p><div class="figure noshadow"><a href="/4.21/zh-CN/img/basic-concepts/rendering/engine-cycle-2fb-no-update.webp" target="_blank"><img src="/4.21/zh-CN/img/basic-concepts/rendering/engine-cycle-2fb-no-update.webp"></a><p>2号帧中无更新</p></div><p>应用在2号帧未绘制任何内容，因此图形引擎在3号帧再次重发2号帧缓冲。</p><p>典型的并行RGB显示屏的刷新率约为60 Hz。 This update frequency must be maintained by the microcontroller. 此更新频率意味着在再次开始发送前，有16 ms的时间可用来渲染新帧。 在某些情况下，渲染新帧的时间超过16 ms。 此时，图形引擎只再次重发相同的帧（同之前一样）：</p><div class="figure noshadow"><a href="/4.21/zh-CN/img/basic-concepts/rendering/engine-cycle-2fb-long-render.webp" target="_blank"><img src="/4.21/zh-CN/img/basic-concepts/rendering/engine-cycle-2fb-long-render.webp"></a><p>渲染时间长</p></div><p>1号帧的渲染时间超过16 ms，因此重发之前渲染到1号帧缓冲的0号帧。 在3号帧发送2号帧缓冲中的新帧。 当有两个帧缓冲可供使用时，渲染时间可能会非常长。 在有新帧可用之前，会一直重发上一帧。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="one-framebuffer">一个帧缓冲<a class="hash-link" href="#one-framebuffer" title="直接链接到标题">​</a></h3><p>在某些系统中，由于存储空间的限制，只能使用1个帧缓冲。 如果使用并行RGB显示屏，则必须在每一帧发送1号帧缓冲。</p><p>由于图形引擎不得不在向显示屏发送帧缓冲的同时将帧绘制到同一个帧缓冲，因此会产生问题。 如果不加注意就这样做，会有一个极大的风险，即显示屏会显示上一帧与新帧的混合帧。</p><p>One solution is to hold back the drawing until the transfer is complete and only draw in the time-slot before the transfer starts again. 由于传输占用了整个帧时间的很大一部分，因此可用于绘制帧的时间极少。 另一个缺点是如果在下一次传输开始时绘制未完成，则仍可能出现不完整的帧（撕裂）。</p><p>一种更有潜力的解决方案是监测帧缓冲已发送的量，然后将渲染限制在帧缓冲的合适部分。 虽然传输的进行，帧缓冲有越来越多的部分可供渲染算法使用。</p><p>图形引擎包含帮助程序员确保绘制正确执行的算法。</p><p>应用在每一帧更新并渲染帧缓冲：</p><div class="figure noshadow"><a href="/4.21/zh-CN/img/basic-concepts/rendering/engine-cycle-1fb-normal.webp" target="_blank"><img src="/4.21/zh-CN/img/basic-concepts/rendering/engine-cycle-1fb-normal.webp"></a><p>在每一帧重发一个帧缓冲</p></div><p>如果帧没有更新任何内容，则重发帧缓冲，不做任何更改。</p><p>如果渲染时间超过16 ms，当再次开始重发时，渲染尚未结束：</p><div class="figure noshadow"><a href="/4.21/zh-CN/img/basic-concepts/rendering/engine-cycle-1fb-long-render.webp" target="_blank"><img src="/4.21/zh-CN/img/basic-concepts/rendering/engine-cycle-1fb-long-render.webp"></a><p>渲染时间长</p></div><p>在这种情况下，图形引擎必须确保正在发送的部分已完成渲染。 否则，显示屏将显示未完成的帧缓冲。</p><p>在下一节中，我们将讨论各个Widget的渲染时间。 这将有助于程序员编写出高性能的应用。</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档页面导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/4.21/zh-CN/docs/basic-concepts/graphics-engine"><div class="pagination-nav__sublabel">上一个</div><div class="pagination-nav__label">图形引擎</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/4.21/zh-CN/docs/basic-concepts/performance"><div class="pagination-nav__sublabel">下一个</div><div class="pagination-nav__label">性能</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#collect" class="table-of-contents__link toc-highlight">采集</a></li><li><a href="#update" class="table-of-contents__link toc-highlight">更新</a><ul><li><a href="#time-based-updates" class="table-of-contents__link toc-highlight">基于时间的更新</a></li><li><a href="#requesting-a-redraw" class="table-of-contents__link toc-highlight">请求重绘</a></li></ul></li><li><a href="#render" class="table-of-contents__link toc-highlight">渲染</a></li><li><a href="#wait" class="table-of-contents__link toc-highlight">Wait</a></li><li><a href="#handling-the-framebuffers" class="table-of-contents__link toc-highlight">处理帧缓冲</a><ul><li><a href="#two-framebuffers" class="table-of-contents__link toc-highlight">两个帧缓冲</a></li><li><a href="#one-framebuffer" class="table-of-contents__link toc-highlight">一个帧缓冲</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">All rights reserved © 2022 STMicroelectronics | <a href="https://www.st.com/content/st_com/en/common/terms-of-use.html">Terms of use</a> | <a href="https://www.st.com/content/st_com/en/common/privacy-policy.html">Privacy Policy</a> | <a href="/docs/miscellaneous/cookie-policy">Cookie Policy</a> | <a href="https://app-de.onetrust.com/app/#/webform/2b87200d-4023-4588-9df7-ab0cdea1a67e">Exercise your rights</a></div></div></div></footer></div></div>
<script src="/4.21/zh-CN/assets/js/runtime~main.1202490c.js"></script>
<script src="/4.21/zh-CN/assets/js/main.8eee2a9c.js"></script>
</body>
</html>